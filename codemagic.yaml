# codemagic.yaml
workflows:
  ios-test-build:
    name: iOS Test Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    # –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–±–æ—Ä–∫–∏
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "main"
          include: true
          source: true
      cancel_previous_builds: false
    
    environment:
      # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
      flutter: "3.38.9"
      xcode: "16.0"
      
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      vars:
        BUNDLE_ID: "com.miwken.habittracker"
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        FLUTTER_ROOT: "/Users/builder/flutter"  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å
    
    cache:
      cache_paths:
        - ~/.pub-cache
        - /Users/builder/.gradle/caches
        - ios/Pods
    
    scripts:
      # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Check environment
        script: |
          echo "=== Environment ==="
          echo "Flutter path: $(which flutter)"
          echo "Flutter version:"
          flutter --version
          echo "Xcode version:"
          xcodebuild -version
          echo "Dart version:"
          dart --version
          echo "==================="
      
      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω—É–∂–Ω–∞—è –≤–µ—Ä—Å–∏—è)
      - name: Ensure Flutter 3.38.9
        script: |
          CURRENT_VERSION=$(flutter --version | grep "Flutter" | awk '{print $2}')
          REQUIRED_VERSION="3.38.9"
          
          if [ "$CURRENT_VERSION" != "$REQUIRED_VERSION" ]; then
            echo "Installing Flutter $REQUIRED_VERSION..."
            cd $HOME
            git clone https://github.com/flutter/flutter.git -b $REQUIRED_VERSION flutter-$REQUIRED_VERSION
            export PATH="$HOME/flutter-$REQUIRED_VERSION/bin:$PATH"
            flutter --version
          fi
      
      # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Get Flutter dependencies
        script: |
          echo "Getting dependencies..."
          flutter pub get
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Dart SDK –≤–µ—Ä—Å–∏—é
          echo "Checking Dart SDK compatibility..."
          DART_VERSION=$(dart --version 2>&1 | grep -o "Dart SDK version: [0-9.]*" | cut -d' ' -f4)
          echo "Dart SDK: $DART_VERSION"
      
      # 4. –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—à–∏–±–∫–∏)
      - name: Analyze code
        script: |
          echo "Analyzing code..."
          flutter analyze || echo "Analysis completed with warnings"
      
      # 5. –°–±–æ—Ä–∫–∞ –¥–ª—è iOS (debug, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
      - name: Build iOS Debug
        script: |
          echo "Building iOS debug..."
          
          # –°–Ω–∞—á–∞–ª–∞ —á–∏—Å—Ç–∏–º
          flutter clean
          
          # –°–æ–±–∏—Ä–∞–µ–º –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
          flutter build ios \
            --debug \
            --no-codesign \
            --dart-define=CI_BUILD=true \
            --verbose
          
          echo "‚úÖ Debug build completed"
      
      # 6. –°–±–æ—Ä–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
      - name: Build for iOS Simulator
        script: |
          echo "Building for simulator..."
          flutter build ios \
            --simulator \
            --debug \
            --dart-define=CI_BUILD=true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—Ä–∞–ª–æ—Å—å
          if [ -f "build/ios/iphonesimulator/Runner.app/Runner" ]; then
            echo "‚úÖ Simulator build successful"
            file "build/ios/iphonesimulator/Runner.app/Runner"
          else
            echo "‚ùå Simulator build failed"
            ls -la build/ios/iphonesimulator/
            exit 1
          fi
      
      # 7. –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
      - name: Create Xcode archive (unsigned)
        script: |
          cd ios
          
          echo "Creating Xcode archive..."
          
          # –°–æ–∑–¥–∞–µ–º ExportOptions –¥–ª—è unsigned —Å–±–æ—Ä–∫–∏
          cat > ExportOptions-unsigned.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>compileBitcode</key>
              <false/>
              <key>destination</key>
              <string>export</string>
              <key>method</key>
              <string>development</string>
              <key>signingCertificate</key>
              <string></string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>teamID</key>
              <string></string>
              <key>thinning</key>
              <string>&lt;none&gt;</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
          xcodebuild clean archive \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Debug \
            -archivePath "$HOME/runner.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            | xcpretty && exit ${PIPESTATUS[0]}
          
          echo "‚úÖ Archive created: $HOME/runner.xcarchive"
      
      # 8. –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
      - name: Verify artifacts
        script: |
          echo "=== Build Artifacts ==="
          echo "iOS Debug .app:"
          find build/ios -name "Runner.app" -type d | head -5
          echo ""
          echo "Archive:"
          ls -la $HOME/runner.xcarchive/ 2>/dev/null || echo "No archive found"
          echo "======================"
    
    # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    artifacts:
      - build/ios/**/*.app
      - $HOME/runner.xcarchive
      - build/ios/Flutter/**/*
      - flutter.log
    
    # –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    publishing:
      scripts:
        - name: Build summary
          script: |
            echo "=========================================="
            echo "üöÄ BUILD SUCCESSFUL"
            echo "=========================================="
            echo "App: Habit Tracker"
            echo "Bundle ID: $BUNDLE_ID"
            echo "Flutter: $(flutter --version | grep 'Flutter' | awk '{print $2}')"
            echo "Dart: $(dart --version | grep -o 'Dart SDK version: [0-9.]*' | cut -d' ' -f4)"
            echo ""
            echo "üì¶ Generated artifacts:"
            echo "  ‚Ä¢ Runner.app (iOS Debug)"
            echo "  ‚Ä¢ Runner.app (iOS Simulator)"
            echo "  ‚Ä¢ runner.xcarchive (unsigned)"
            echo ""
            echo "‚ö†Ô∏è  Note: Build is unsigned"
            echo "     For device testing, need Apple Developer account"
            echo "=========================================="